<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- BootStrap Link -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">

    <!-- ToastUI Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- ToastUI Chart -->
    <!--    https://congsong.tistory.com/68  설명 블로그 -->
    <link rel="stylesheet" href="https://uicdn.toast.com/chart/latest/toastui-chart.min.css"/>
    <script src="https://uicdn.toast.com/chart/latest/toastui-chart.min.js"></script>

    <!-- Main Page CSS -->
    <link href="/css/main.css" rel="stylesheet">
    <!-- GuestBoard CSS -->
    <link href="/css/Categories.css" rel="stylesheet">
    <!-- comment CSS -->
    <link href="/css/comment.css" rel="stylesheet">


    <!--    Drop Zone 부분 설명 -->
    <!--    https://inpa.tistory.com/entry/Dropzone-%F0%9F%93%9A-%EC%9D%B4%EB%AF%B8%EC%A7%80-%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C-%EB%93%9C%EB%9E%98%EA%B7%B8-%EC%95%A4-%EB%93%9C%EB%A1%AD-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%EC%82%AC%EC%9A%A9%EB%B2%95-->
    <!-- Plugin -->
    <link rel="stylesheet" href="https://rawgit.com/enyo/dropzone/master/dist/dropzone.css"/>
    <script src="https://rawgit.com/enyo/dropzone/master/dist/dropzone.js"></script>
    <!--    Drop Zone END -->

    <style>
    </style>
</head>

<body>
<!-- Header Start -->
<header class="p-3 bg-warning text-white">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-between">
            <a href="/" class="nav-link" style="display: flex; align-items: center;">
                <img src="/images/dog4.png" alt="Home"
                     style="width: 60px; height: 50px; border-radius: 10%; object-fit: cover;">
            </a>
            <h1 style="font-weight: bold">Animal Cafe 자유게시판</h1>
            <div class="row justify-content-end">
                <form class="text-end ml-3 mr-3" th:action="@{/search_find}" method="get">
                    <input type="search" class="form-control form-control-dark" placeholder="Search..."
                           aria-label="Search">
                </form>
                <div class="text-end ml-auto d-flex">
                    <button type="button" class="btn btn-info me-2" id="login" sec:authorize="isAnonymous()">Login
                    </button>
                    <!-- 로그아웃 버튼 -->
                    <form action="/kakao/logout" method="post">
                        <button type="submit" sec:authorize="isAuthenticated()" class="btn btn-danger me-2 ml-2">
                            Logout
                        </button>
                    </form>
                    <button type="button" sec:authorize="isAnonymous()" class="btn btn-dark me-2 ml-2" id="signup">
                        Sign-up
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>
<!-- Header End -->

<!-- To The Top -->
<br id="mainPage">

<div class="container-fluid container">
    <!-- Nav Start -->
    <div class="nav-container">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <div class="mx-auto">
                    <div class="col-lg-4">
                        <a href="/personal_info">
                            <svg class="bd-placeholder-img rounded-circle mt-2" width="140" height="140"
                                 xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: 140x140"
                                 preserveAspectRatio="xMidYMid slice" focusable="false">
                                <title>Placeholder</title>

                                <!-- 원형으로 자르기 위한 클립 경로 정의 -->
                                <defs>
                                    <clipPath id="circleView">
                                        <circle cx="50%" cy="50%" r="50%" />
                                    </clipPath>
                                </defs>

                                <!-- 이미지 삽입 -->
                                <image class="mt-3" href="/images/nuguri.gif" width="140" height="140" clip-path="url(#circleView)"></image>

                                <sec:authorize access="isAuthenticated()">
                                    <text x="50%" y="50%" fill="#777" dy=".3em">140x140</text>
                                </sec:authorize>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Navigation Menu -->
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="/" class="nav-link active nav-home" aria-current="page" style="margin: 20px">
                    <svg class="bi me-2" width="16" height="16">
                        <use xlink:href="#home"></use>
                    </svg>
                    Home
                </a>
            </li>
            <li>
                <a href="/freeBoard" class="nav-link link-dark">
                    <svg class="bi me-2" width="16" height="16">
                        <use xlink:href="#speedometer2"></use>
                    </svg>
                    자유게시판
                </a>
            </li>
            <li>
                <a href="/QnA" class="nav-link link-dark">
                    <svg class="bi me-2" width="16" height="16">
                        <use xlink:href="/QnA"></use>
                    </svg>
                    QnA
                </a>
            </li>
            <li>
                <a href="/UCC" class="nav-link link-dark">
                    <svg class="bi me-2" width="16" height="16">
                        <use xlink:href="/UCC"></use>
                    </svg>
                    UCC
                </a>
            </li>
            <li>
                <a href="/guestBook" class="nav-link link-dark">
                    <svg class="bi me-2" width="16" height="16">
                        <use xlink:href="/guestBook"></use>
                    </svg>
                    방명록
                </a>
            </li>
        </ul>
        <!-- Navigation Menu END -->

        <!-- Chart Count   -->
        <div id="chart" style="margin-left: 10px; margin-top: 20px"></div>
        <!-- Chart Count  END   -->
    </div>
    <!-- Nav End -->

    <!-- Main Content -->
    <div class="main-content">
        <!-- Banner -->
        <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
            <ol class="carousel-indicators">
                <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
                <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
            </ol>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img class="d-block w-100" src="/images/banner.jpg" alt="First slide">
                </div>
                <div class="carousel-item">
                    <img class="d-block w-100" src="/images/banner2.jpg" alt="Second slide">
                </div>
                <div class="carousel-item">
                    <img class="d-block w-100" src="/images/banner3.png" alt="Third slide">
                </div>
            </div>
            <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>

        <div class="p-1 mb- bg-light rounded-3" style="margin-top: 20px">
            <!-- Information -->
            <div class="p-1 mb- bg-light rounded-3">
                <div class="container-fluid py-5">
                    <div>
                        <h1 class="black-han-sans-regular ">안내</h1></div>
                    <div class="col-md-12 fs-4">
                        <p>※ 혐오 글 작성 및 타인에 명예에 모욕이 가는 글은 자제해주세요. </p>
                        <p>※ 이상한 사진 또는 음란물인경우에는 국번없이 1377 에 신고하여주십시오. </p>
                        <p>※ 오늘도 좋은 하루되세요 ♥</p>
                    </div>
                </div>
            </div>

            <!-- 글쓰기 -->
            <div class="ml-3 row align-items-md-stretch">
                <div class="p-3 mb-1 bg-white border rounded-3" style="width: 700px">
                    <div class="col-md-20" style="line-height: 1.6">

                        <h3>제목</h3>
                        <h1 class="black-han-sans-regular" th:text="${article.title}"> 제목</h1>
                        <div class="mb-3">
                            <!--                            <div id="board_category"> 게시판 카테고리 : 게시판 종류 넣는곳 </div>-->
                        </div>

                        <hr>

                        <div class="mb-3">
                            <p>작성자 : <span th:text="${article.getMember().getNickname()}"></span></p>
                            <label for="show_content">내용</label>
                            <div id="show_content"><br>
                                <p th:utext="${article.content}"></p>
                                <br><br><br><br></div>
                        </div>

                        <div style="margin-bottom: 20px" th:if="${isAuthor}">
                            <button id="delete-btn" class="btn btn-info" style="background: indianred; float: right;">
                                삭제
                            </button>
                            <button class="btn btn-info me-2" style=" float: right; margin-right: 10px"> 수정</button>
                            <br>
                        </div>
                        <input type="hidden" id="article-id" th:value="${article.id}">



                        <hr>
                        <tr th:each="comment : ${comments}" th:unless="${comment.parentCommentId}">
                            <td th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                            <td th:text="${comment.member.nickname}"></td>
                            <td>
                                <div>
                                    <span th:text="${comment.content}">${comment.content}</span>
                                    <button type="button" class="btn btn-link toggle-reply-btn">대댓글 보기/감추기</button>
                                    <input type="hidden" name="articleCommentId" th:value="${comment.id}">
                                    <button type="button" class="btn btn-danger delete-comment-btn"
                                            th:attr="data-comment-id=${comment.id}" sec:authorize="isAuthenticated()">삭제
                                    </button>
                                </div>
                                <!-- 대댓글 섹션 -->
                                <div class="comment-list" id="comment-list" style="display: none;">

                                    <ul th:each="reply : ${comment.childComments}">
                                        <li>
                                            <div class="comment">
                                                <span th:text="${reply.member.nickname}"></span>
                                                <span th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                                                <span th:text="${reply.content}">${reply.content}</span>
                                                <input type="hidden" name="replyId" th:value="${reply.id}">
                                                <button type="button" class="btn btn-danger delete-reply-btn" sec:authorize="isAuthenticated()">삭제
                                                </button>
                                            </div>
                                        </li>
                                    </ul>
                                    <div class="reply-form" id="reply-form-${comment.id}" style="display: none;" sec:authorize="isAuthenticated()">
                                        <form th:action="@{/comments/{articleId}/{parentCommentId}(articleId=${article.id}, parentCommentId=${comment.id})}" method="post">
                                            <input type="hidden" name="parentCommentId" th:value="${comment.id}"/>
                                            <textarea class="form-control" name="content" placeholder="답글을 입력하세요"></textarea>
                                            <button type="submit" class="btn btn-primary">답글 작성</button>
                                        </form>
                                    </div>

                                </div>
                            </td>
                        </tr>

                    </div>
                </div>
            </div>
        </div>

        <form id="comment-form" sec:authorize="isAuthenticated()">
            <div class="form-group">
                <label for="comment">댓글 추가:</label>
                <textarea class="form-control" id="comment" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" id="create-comment-btn">댓글 작성</button>
        </form>

        <!--  advert content  -->
        <div class="p-5 mb-4 bg-light rounded-3" style="margin-top: 10px;">
            광고
            <img src="/images/banner.jpg" style="width: 100%" alt=""
                 onclick="window.open('https://jennetph.co.kr/', '_blank')">
            <hr>
            <h3 style="color: red"> 국내 1위 동물병원 055-585-1718 </h3>
            <h5> 동물을 사랑하는 여러분들을 위해 최저가로 모십니다.</h5>
        </div>
    </div>

    <!-- Main Content End -->
</div>

<!--Footer -->
<footer class="footer mt-auto py-3" style="background-color: #f8f9fa;">
    <div class="container">
        <div class="text-center text-muted py-3">
            <p class="mb-0">국립창원대학교 (우)51140 경남 창원시 의창구 창원대학로 20 - 조원: 임경용, 양민혁, 고승우</p>
        </div>
    </div>
    <!-- Button to Top-->
    <button id="topBtn" onclick="scrollToTop()" class="circle-button">위로이동</button>
    <div class="bottomTop"> &nbsp;</div>
</footer>
<!--Footer End -->

</body>

<!--<script src="/js/all.js"></script>-->
<script src="/js/columnGraph.js"></script>

<script>
    const deleteButton = document.getElementById('delete-btn');
    console.log(deleteButton);

    // window.onload = function() {
    //     const articleId = window.location.pathname.split('/')[2];
    //     fetchComments(articleId);
    // };


    if (deleteButton) {
        deleteButton.addEventListener('click', event => {
            console.log('ㅎㅇ');
            let id = document.getElementById('article-id').value;
            console.log('ㅎㅇ' + "  id ");
            fetch(`/api/articles/${id}`, {
                method: 'DELETE'
            })
                .then(() => {
                    alert('삭제가 완료되었습니다.');
                    location.replace('/');
                });
        });
    }
    // 대댓글 토글 기능
    document.querySelectorAll('.toggle-reply-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            const replySection = button.parentElement.nextElementSibling;
            if (replySection.style.display === 'none' || replySection.style.display === '') {
                replySection.style.display = 'block';
                // 대댓글 입력 창 토글
                const replyForm = replySection.querySelector('.reply-form');
                replyForm.style.display = 'block';
            } else {
                replySection.style.display = 'none';
                // 대댓글 입력 창 숨기기
                const replyForm = replySection.querySelector('.reply-form');
                replyForm.style.display = 'none';
            }
        });
    });

    // 댓글 작성
    document.getElementById('create-comment-btn').addEventListener('click', function (event) {
        console.log('버튼이 클릭되었습니다.');
        event.preventDefault(); // 기본 폼 제출 방지

        const comment = document.getElementById('comment').value;
        const articleId = window.location.pathname.split('/')[2];

        if (!comment || !articleId) {
            alert('댓글 내용 또는 게시글 ID가 비어 있습니다.');
            return;
        }

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/comments/' + articleId);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {
            if (xhr.status === 204) {  // 204는 No Content로 성공을 의미합니다.
                alert('댓글이 성공적으로 작성되었습니다.');
                window.location.reload(); // 현재 페이지 리로드
            } else {
                alert('댓글 작성에 실패했습니다. 다시 시도해주세요.');
                console.error('댓글 작성 실패:', xhr.statusText);
            }
        };
        xhr.send(JSON.stringify({ content: comment }));
    });

    // 댓글 삭제
    document.querySelectorAll('.delete-comment-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            const articleCommentId = button.parentElement.querySelector('input[name="articleCommentId"]').value;
            const articleId = window.location.pathname.split('/')[2];

            if (confirm('정말로 삭제하시겠습니까?')) {
                const xhr = new XMLHttpRequest();
                xhr.open('DELETE', '/comments/' + articleId + '/' + articleCommentId);
                xhr.onload = function () {
                    if (xhr.status === 200 || xhr.status === 204) {
                        window.location.reload(); // 현재 페이지 리로드
                    } else {
                        console.error('댓글 삭제 실패:', xhr.statusText);
                    }
                };
                xhr.send();
            }
        });
    });

    // 대댓글 삭제
    document.querySelectorAll('.delete-reply-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            const replyId = button.parentElement.querySelector('input[name="replyId"]').value;
            const articleId = window.location.pathname.split('/')[2];

            if (confirm('대댓글을 삭제하시겠습니까?')) {
                const xhr = new XMLHttpRequest();
                xhr.open('DELETE', '/comments/' + articleId + '/replies/' + replyId);
                xhr.onload = function () {
                    if (xhr.status === 204) {
                        window.location.reload(); // 현재 페이지 리로드
                    } else {
                        console.error('대댓글 삭제 실패:', xhr.statusText);
                    }
                };
                xhr.send();
            }
        });
    });

</script>
</html>

